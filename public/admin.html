<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-slate-50 to-gray-100 min-h-screen">
    <!-- Login Form -->
    <div id="loginForm" class="login-container">
        <div class="login-card">
            <h2 class="login-title"><i class="fas fa-lock mr-2"></i>Admin Login</h2>
            <form id="loginFormElement">
                <div class="form-group">
                    <label for="email" class="form-label"><i class="fas fa-envelope mr-2"></i>Email</label>
                    <input 
                        type="email" 
                        id="email" 
                        required
                        class="form-input"
                        placeholder="Enter your email"
                    >
                </div>
                <div class="form-group">
                    <label for="password" class="form-label"><i class="fas fa-lock mr-2"></i>Password</label>
                    <input 
                        type="password" 
                        id="password" 
                        required
                        class="form-input"
                        placeholder="Enter your password"
                    >
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt mr-2"></i>Login
                </button>
            </form>
            <p class="login-footer">Don't have an account? Contact administrator</p>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="container">
                <div class="nav-content">
                    <div class="logo">                        <h1><i class="fas fa-lock mr-2"></i>Comatozze Gallery Admin</h1>
                    </div>
                    <div class="nav-right">
                        <span id="userEmail" class="user-email"></span>
                        <button id="logoutBtn" class="btn btn-secondary ml-2">
                            <i class="fas fa-sign-out-alt mr-1"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Hero Section -->
        <section class="hero admin-hero">
            <div class="container">
                <h2 class="hero-title"><i class="fas fa-tachometer-alt mr-2"></i>Dashboard</h2>
                <p class="hero-subtitle">Manage your gallery content</p>
            </div>
        </section>

        <!-- Main Content -->
        <main class="container main-content">
            <!-- Admin Panel -->
            <div class="admin-panel">
                <!-- Add Image Form -->
                <form id="addImageForm" class="form-container">
                    <h3 class="form-title"><i class="fas fa-plus-circle mr-2"></i>Add New Image</h3>
                    <div class="form-group">
                        <label for="imageTitle" class="form-label"><i class="fas fa-heading mr-2"></i>Title *</label>
                        <input 
                            type="text" 
                            id="imageTitle" 
                            required
                            class="form-input"
                            placeholder="Enter image title"
                        >
                    </div>
                    <div class="form-group">
                        <label for="imageDescription" class="form-label"><i class="fas fa-align-left mr-2"></i>Description</label>
                        <textarea 
                            id="imageDescription" 
                            rows="3"
                            class="form-input"
                            placeholder="Enter image description"
                        ></textarea>
                    </div>
                    <div class="form-group">
                        <label for="imageUrl" class="form-label">
                            <i class="fas fa-link mr-2"></i>Image URL *
                            <span class="text-xs text-gray-500 block mt-1">Must be HTTPS and end with .jpg, .jpeg, .png, .webp, or .gif</span>                        </label>
                        <input 
                            type="url" 
                            id="imageUrl" 
                            required
                            placeholder="https://example.com/image.jpg"
                            class="form-input"
                            onblur="validateImageUrl(this)"
                        >
                    </div>
                    <button 
                        type="submit" 
                        class="btn btn-primary"
                    >
                        <i class="fas fa-plus mr-2"></i>Add Image
                    </button>
                </form>

                <!-- Update/Delete Section -->
                <div class="manage-section">
                    <h3 class="section-title"><i class="fas fa-images mr-2"></i>Manage Images</h3>
                    <div id="imagesList" class="images-list">
                        <!-- Images will be loaded here -->
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <p>&copy; 2026 Comatozze Admin. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://ebvnrsxalfmkdbvvpcnq.supabase.co'; // Replace with your Supabase URL
        const SUPABASE_ANON_KEY = 'sb_publishable_-YhCBggiQY0Re2IGUPSqgA_VdpMhlj9'; // Replace with your Supabase anon key
        const API_BASE = 'https://weathered-moon-9c2c.metaspace.workers.dev'; // Replace with your worker URL

        // DOM Elements
        const elements = {
            loginForm: document.getElementById('loginForm'),
            loginFormElement: document.getElementById('loginFormElement'),
            email: document.getElementById('email'),
            password: document.getElementById('password'),
            adminDashboard: document.getElementById('adminDashboard'),
            userEmail: document.getElementById('userEmail'),            logoutBtn: document.getElementById('logoutBtn'),
            addImageForm: document.getElementById('addImageForm'),
            imagesList: document.getElementById('imagesList'),
            imageUrl: document.getElementById('imageUrl')
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            // Check if user is already logged in
            const token = localStorage.getItem('admin_token');
            if (token) {
                showDashboard(token);
            } else {
                showLoginForm();
            }
            
            setupEventListeners();
        });

        function setupEventListeners() {
            // Login Form
            elements.loginFormElement.addEventListener('submit', handleLogin);
            
            // Logout Button
            elements.logoutBtn.addEventListener('click', handleLogout);
            
            // Add Image Form
            elements.addImageForm.addEventListener('submit', handleAddImage);
        }

        function showLoginForm() {
            elements.loginForm.classList.remove('hidden');
            elements.adminDashboard.classList.add('hidden');
        }

        function showDashboard(token) {
            elements.loginForm.classList.add('hidden');
            elements.adminDashboard.classList.remove('hidden');
            
            // Show user email
            const email = localStorage.getItem('user_email');
            elements.userEmail.textContent = email;
            
            // Load images
            loadImagesForAdmin(token);
        }

        async function handleLogin(e) {
            e.preventDefault();
                        const email = elements.email.value.trim();
            const password = elements.password.value.trim();
            
            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }

            try {
                // Simulate login to Supabase (replace with actual Supabase auth)
                // In real implementation, you would use Supabase JS library
                const response = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY
                    },
                    body: JSON.stringify({
                        email,
                        password
                    })
                });

                if (!response.ok) {
                    throw new Error('Invalid credentials');
                }

                const data = await response.json();
                const token = data.access_token;
                
                // Store token and email
                localStorage.setItem('admin_token', token);
                localStorage.setItem('user_email', email);
                
                // Show dashboard
                showDashboard(token);
                
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please check your credentials.');
            }
        }

        function handleLogout() {
            localStorage.removeItem('admin_token');
            localStorage.removeItem('user_email');
            showLoginForm();
        }

        async function loadImagesForAdmin(token) {            try {
                const response = await fetch(`${API_BASE}/api/images?limit=100&offset=0`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const images = await response.json();
                renderAdminImages(images);
            } catch (error) {
                console.error('Error loading admin images:', error);
                alert('Failed to load images for admin panel');
            }
        }

        async function handleAddImage(e) {
            e.preventDefault();
            
            const token = localStorage.getItem('admin_token');
            if (!token) {
                alert('Session expired. Please log in again.');
                showLoginForm();
                return;
            }

            const formData = {
                title: document.getElementById('imageTitle').value.trim(),
                description: document.getElementById('imageDescription').value.trim(),
                image_url: document.getElementById('imageUrl').value.trim()
            };

            if (!formData.title || !formData.image_url) {
                alert('Title and Image URL are required');
                return;
            }

            // Validate URL format
            if (!isValidImageUrl(formData.image_url)) {
                alert('Please enter a valid HTTPS URL ending with .jpg, .jpeg, .png, .webp, or .gif');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/images`, {
                    method: 'POST',
                    headers: {                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add image');
                }

                const result = await response.json();
                alert('Image added successfully!');
                
                // Reset form
                elements.addImageForm.reset();
                
                // Reload admin list
                loadImagesForAdmin(token);
            } catch (error) {
                console.error('Error adding image:', error);
                alert(`Error: ${error.message}`);
            }
        }

        function renderAdminImages(images) {
            elements.imagesList.innerHTML = '';

            images.forEach(image => {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'admin-image-item';
                
                imageDiv.innerHTML = `
                    <img src="${image.image_url}" alt="${image.title}" class="admin-image-thumb">
                    <div class="admin-image-details">
                        <h4 class="admin-image-title">${image.title}</h4>
                        <p class="admin-image-desc">${image.description || 'No description'}</p>
                        <p class="admin-image-date">${new Date(image.created_at).toLocaleDateString()}</p>
                    </div>
                    <div class="admin-actions">
                        <button 
                            onclick="editImage('${image.id}')" 
                            class="btn btn-secondary"
                        >
                            <i class="fas fa-edit mr-1"></i>Edit
                        </button>
                        <button 
                            onclick="deleteImage('${image.id}')" 
                            class="btn btn-danger"
                        >                            <i class="fas fa-trash mr-1"></i>Delete
                        </button>
                    </div>
                `;
                
                elements.imagesList.appendChild(imageDiv);
            });
        }

        async function deleteImage(id) {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                alert('Session expired. Please log in again.');
                showLoginForm();
                return;
            }

            if (!confirm('Are you sure you want to delete this image?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/images/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete image');
                }

                alert('Image deleted successfully!');
                
                // Reload lists
                loadImagesForAdmin(token);
            } catch (error) {
                console.error('Error deleting image:', error);
                alert(`Error: ${error.message}`);
            }
        }

        async function editImage(id) {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                alert('Session expired. Please log in again.');
                showLoginForm();
                return;            }

            try {
                // Fetch current image data
                const response = await fetch(`${API_BASE}/api/images/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const image = await response.json();
                
                // Prompt for new values
                const newTitle = prompt('New Title:', image.title) || image.title;
                const newDescription = prompt('New Description:', image.description || '');
                const newImageUrl = prompt('New Image URL:', image.image_url) || image.image_url;

                if (newTitle === image.title && newDescription === (image.description || '') && newImageUrl === image.image_url) {
                    return; // No changes
                }

                // Validate new URL if changed
                if (newImageUrl !== image.image_url && !isValidImageUrl(newImageUrl)) {
                    alert('Please enter a valid HTTPS URL ending with .jpg, .jpeg, .png, .webp, or .gif');
                    return;
                }

                // Update image
                const updateResponse = await fetch(`${API_BASE}/api/images/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        title: newTitle,
                        description: newDescription || null,
                        image_url: newImageUrl
                    })
                });

                if (!updateResponse.ok) {
                    const error = await updateResponse.json();
                    throw new Error(error.error || 'Failed to update image');
                }
                alert('Image updated successfully!');
                
                // Reload lists
                loadImagesForAdmin(token);
            } catch (error) {
                console.error('Error editing image:', error);
                alert(`Error: ${error.message}`);
            }
        }

        // URL validation function
        function isValidImageUrl(urlString) {
            if (typeof urlString !== 'string' || urlString.trim() === '') return false;

            try {
                const url = new URL(urlString);
                
                if (url.protocol !== 'https:') return false;
                
                if (!url.hostname || url.hostname === 'localhost') return false;
                
                const pathname = url.pathname;
                const extMatch = pathname.match(/\.[a-zA-Z]{3,4}(?:\?|#|$)/);
                if (!extMatch) return false;
                
                const ext = extMatch[0].split('?')[0].split('#')[0].toLowerCase();
                const validExtensions = ['.jpg', '.jpeg', '.png', '.webp', '.gif'];
                
                return validExtensions.includes(ext);
            } catch (e) {
                return false;
            }
        }

        // URL validation on blur
        function validateImageUrl(input) {
            const url = input.value.trim();
            if (!url) return;
            
            try {
                const u = new URL(url);
                if (u.protocol !== 'https:') {
                    input.setCustomValidity('Must be HTTPS URL');
                } else if (! /\.(jpg|jpeg|png|webp|gif)$/.test(u.pathname.toLowerCase())) {
                    input.setCustomValidity('Must end with .jpg, .jpeg, .png, .webp, or .gif');
                } else {
                    input.setCustomValidity('');
                }
            } catch (e) {
                input.setCustomValidity('Invalid URL format');            }
        }

        // Make functions available globally for inline event handlers
        window.editImage = editImage;
        window.deleteImage = deleteImage;
    </script>
</body>
</html>
